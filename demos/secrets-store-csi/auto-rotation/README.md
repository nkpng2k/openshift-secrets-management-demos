# Auto-Rotation Demo

This is a simple demo using a `busybox` container image
to consume a `Secret` generated by a deployment of the
[Secrets Store CSI Driver](https://secrets-store-csi-driver.sigs.k8s.io/introduction),
and then poll the external secrets manager for changes
to the secret. When the secret is updated upstream,
Secret Store CSI will update the secret within the running
pod.

## About auto-rotation

Secrets store csi has the ability to automatically rotate the secrets
mounted to running workloads when the secret is updated in the upstream
secrets management software (for example: Vault). Auto-rotation is enabled
by default for the Red Hat OpenShift version of Secrets Store CSI, and
you can find a list of providers that support automatic rotation
[here](https://secrets-store-csi-driver.sigs.k8s.io/providers).

By default, the polling period for automatic rotation is 2 minutes, but
this can be changed if shorter (or longer) polling periods are required.

## Prerequisites

Must have the following installed:
- `oc`
- `helm`

Must have admin credentials for an OpenShift cluster and be logged in via:
`oc login ...`

## Steps

1. Make sure to have `oc` and `helm` installed
2. Make sure to log in with your admin credentials via `oc login` command
3. You can make edits to the `variables.sh` file if you want to configure
where to point the demo to for some things.
4. Run the scripts in order from the `src` folder:
```sh
# Installs the external secrets manager. Vault is currently the only supported
./01_install_external_secrets_repo.sh

# Installs Secrets Store CSI and necessary configurations
./02_install_secrets_store_csi.sh

# Configures the running Vault with some dummy values and enables Kubernetes auth
./03_add_secret_values.sh

# Deploys a sample application and performs a simple validation
./04_deploy_example_application.sh

# Update secret in Vault and wait for SSCSI notice the secret change
./05_demo_auto_rotation.sh

# Cleanup step. Tearsdown the resources created during the prior steps
./06_cleanup.sh
```

## Disclaimer

This is not guaranteed to work in all environments, and is meant to showcase
an extremely simple example of how Secrets Store CSI can consume secrets from
an external secret manager.

## Known issue:

There is a known bug with the Vault helm charts that results in an `ImagePullBackoff`
error on the `vault-csi-provider` pod. [link](https://github.com/hashicorp/vault-helm/issues/1140)

This error can be ignored and does not impact the demo.
